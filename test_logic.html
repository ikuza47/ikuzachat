<!DOCTYPE html>
<html>
<head>
    <title>Test HTML Entities Processing</title>
</head>
<body>
    <h1>Testing HTML Entities and Message Hiding</h1>
    <div id="output"></div>

    <script>
        // Simulate the escapeHtml function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Simulate the logic from the fixed twitch-connect.js
        function processText(text) {
            let output = `Input text: ${text}<br>`;
            
            // Check if it contains HTML tags (excluding entities)
            if (/<[^>]*>/i.test(text) && !text.includes('&')) {
                output += 'Contains HTML tags, escaping: ' + escapeHtml(text) + '<br>';
                return output + 'Result: ' + escapeHtml(text) + '<br><br>';
            } else if (text.includes('&')) {
                // If text contains & (possibly entities), check for actual tags
                const tagRegex = /<[^>]*>/g;
                if (tagRegex.test(text)) {
                    output += 'Contains both entities and HTML tags, escaping only tags<br>';
                    const result = text.replace(tagRegex, function(match) {
                        return escapeHtml(match);
                    });
                    return output + 'Result: ' + result + '<br><br>';
                } else {
                    output += 'Contains only entities, keeping as is<br>';
                    return output + 'Result: ' + text + '<br><br>';
                }
            } else {
                output += 'No HTML tags, returning as is<br>';
                return output + 'Result: ' + text + '<br><br>';
            }
        }

        // Test cases
        const outputDiv = document.getElementById('output');
        
        outputDiv.innerHTML += '<h3>Testing HTML entities preservation:</h3>';
        outputDiv.innerHTML += processText('Hello &nbsp; world');
        outputDiv.innerHTML += processText('Hello &#160; world');
        outputDiv.innerHTML += processText('Hello <script>alert("dangerous")</script> world');
        outputDiv.innerHTML += processText('Entity &nbsp; with <b>HTML tag</b>');
        outputDiv.innerHTML += processText('Normal text without HTML');
        
        // Test message hiding state
        outputDiv.innerHTML += '<h3>Testing message hiding functionality:</h3>';
        let messageHidden = false;
        
        function simulateMessage(text) {
            let result = `Processing: "${text}" | Hidden state: ${messageHidden} | `;
            
            // If messages are hidden, check for show command
            if (messageHidden) {
                if (text.includes('->')) {
                    messageHidden = false;
                    return result + "Found '->', unhide and skip this message<br>";
                }
                return result + "Message is hidden<br>";
            } else if (text.includes('<!-')) {
                messageHidden = true;
                return result + "Found '<!-', hide following messages<br>";
            }
            
            return result + "Display message<br>";
        }
        
        messageHidden = false;
        outputDiv.innerHTML += simulateMessage("Normal message");
        outputDiv.innerHTML += simulateMessage("Another normal message");
        outputDiv.innerHTML += simulateMessage("Hide next messages <!-");
        outputDiv.innerHTML += simulateMessage("This should be hidden");
        outputDiv.innerHTML += simulateMessage("So should this");
        outputDiv.innerHTML += simulateMessage("Show messages again ->");
        outputDiv.innerHTML += simulateMessage("This should be visible");
    </script>
</body>
</html>